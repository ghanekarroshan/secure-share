<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SecureShare</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <div class="logo">üîê SecureShare</div>
                <ul class="nav-links">
                    <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li><a href="{{ url_for('profile') }}">Profile</a></li>
                    <li><a href="{{ url_for('logout') }}">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <div>
                    <h1>Welcome back, {{ user.username }}!</h1>
                    <p>Manage your secure file sharing</p>
                </div>
                <div>
                    <span style="color: #666;">{{ files|length }} files uploaded</span>
                </div>
            </div>

            <div class="upload-section">
                <h2>üì§ Upload New File</h2>
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                    <h3>Drag & Drop your file here</h3>
                    <p>or click to browse</p>
                    <input type="file" id="fileInput" style="display: none;">
                </div>
                
                <div id="uploadForm" style="display: none; margin-top: 2rem;">
                    <div class="form-group">
                        <label for="filePassword">File Password (required for encryption)</label>
                        <input type="password" id="filePassword" placeholder="Enter a strong password">
                    </div>
                    <button class="btn-auth" onclick="uploadFile()">Upload & Encrypt</button>
                </div>
            </div>

            <div class="files-section">
                <h2>üìã Your Files</h2>
                {% if files %}
                    <div class="files-grid">
                        {% for file in files %}
                            <div class="file-item">
                                <div class="file-info">
                                    <h4>üìÑ {{ file.original_filename }}</h4>
                                    <div class="file-meta">
                                        <p>Uploaded: {{ file.upload_date.strftime('%Y-%m-%d %H:%M') }}</p>
                                        <p>Size: {{ "%.2f"|format(file.file_size / 1024 / 1024) }} MB</p>
                                        <p>Downloads: {{ file.download_count }}/{{ file.max_downloads }}</p>
                                        {% if file.expiry_date %}
                                            <p>Expires: {{ file.expiry_date.strftime('%Y-%m-%d %H:%M') }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn-small btn-copy" onclick="copyLink('{{ request.host_url }}download/{{ file.secure_link }}')">Copy Link</button>
                                    <button class="btn-small btn-delete" onclick="deleteFile({{ file.id }})">Delete</button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; padding: 2rem;">No files uploaded yet. Upload your first file above!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="linkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîó Secure Link Generated</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <p>Your file has been encrypted and a secure link has been generated:</p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0; word-break: break-all;">
                <input type="text" id="generatedLink" readonly style="width: 100%; border: none; background: transparent;">
            </div>
            <button class="btn-primary" onclick="copyGeneratedLink()">Copy Link</button>
            <button class="btn-secondary" onclick="closeModal()">Close</button>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}" style="position: fixed; top: 100px; right: 20px; z-index: 3000; max-width: 300px;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <script>
        let selectedFile = null;

        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        });

        function handleFileSelect(file) {
            selectedFile = file;
            document.getElementById('uploadForm').style.display = 'block';
            document.getElementById('uploadArea').innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                <h3>${file.name}</h3>
                <p>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
            `;
        }

        async function uploadFile() {
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            const filePassword = document.getElementById('filePassword').value;
            if (!filePassword) {
                alert('Please enter a file password for encryption');
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('file_password', filePassword);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('generatedLink').value = result.secure_link;
                    document.getElementById('linkModal').style.display = 'flex';
                    
                    // Reset upload form
                    selectedFile = null;
                    document.getElementById('filePassword').value = '';
                    document.getElementById('uploadForm').style.display = 'none';
                    document.getElementById('uploadArea').innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                        <h3>Drag & Drop your file here</h3>
                        <p>or click to browse</p>
                    `;
                    
                    // Refresh page after 2 seconds to show new file
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('Upload failed: ' + result.error);
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }

        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        function copyGeneratedLink() {
            const link = document.getElementById('generatedLink').value;
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        function closeModal() {
            document.getElementById('linkModal').style.display = 'none';
        }

        async function deleteFile(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                try {
                    const response = await fetch(`/delete/${fileId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to delete file');
                    }
                } catch (error) {
                    alert('Failed to delete file: ' + error.message);
                }
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('linkModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
